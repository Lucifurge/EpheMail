<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail.tm API Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333;
            color: white;
            padding: 20px;
        }
        button {
            background-color: #007BFF;
            border: none;
            padding: 10px;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .output {
            margin-top: 20px;
            background-color: #444;
            padding: 10px;
            border-radius: 5px;
        }
        a {
            color: #007BFF;
        }
    </style>
</head>
<body>

    <h1>Mail.tm API Integration</h1>

    <button onclick="fetchDomains()">Get Domains</button>
    <button onclick="createAccount()">Create Account</button>
    <button onclick="getMessages()">Get Messages</button>

    <div class="output" id="output"></div>

    <script>
        const apiUrl = 'https://api.mail.tm'; // Base URL for Mail.tm API
        let token = ''; // Store the Bearer token
        let accountId = ''; // Store the account ID
        let selectedDomain = ''; // Store the selected domain

        // Function to fetch available domains
        async function fetchDomains() {
            try {
                const response = await fetch(`${apiUrl}/domains`);
                const data = await response.json();
                
                if (data['hydra:member'].length > 0) {
                    selectedDomain = data['hydra:member'][0].domain;
                    displayMessage(`Domain selected: ${selectedDomain}`);
                } else {
                    displayMessage('No domains available.');
                }
            } catch (error) {
                displayMessage('Error fetching domains: ' + error.message);
            }
        }

        // Function to create a temporary email account
        async function createAccount() {
            if (!selectedDomain) {
                displayMessage('Please fetch domains first.');
                return;
            }

            // Ensure the email format is correct
            const email = `user@${selectedDomain}`;
            const password = 'randompassword'; // Use a static password for demo purposes

            try {
                const response = await fetch(`${apiUrl}/accounts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address: email, password })
                });

                const data = await response.json();
                
                if (response.status === 201 && data.id) {
                    accountId = data.id;
                    displayMessage(`Account created: ${email}`);
                    authenticateAccount(data.address, password);  // Authenticate to get the token
                } else {
                    displayMessage('Account creation failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                displayMessage('Error creating account: ' + error.message);
            }
        }

        // Function to authenticate and get token
        async function authenticateAccount(email, password) {
            try {
                const response = await fetch(`${apiUrl}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address: email, password })
                });

                const data = await response.json();
                if (data.token) {
                    token = data.token;
                    displayMessage('Authenticated! Token: ' + token);
                } else {
                    displayMessage('Authentication failed.');
                }
            } catch (error) {
                displayMessage('Error during authentication: ' + error.message);
            }
        }

        // Function to get messages from the created account
        async function getMessages() {
            if (!token) {
                displayMessage('Please create an account and authenticate first.');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/messages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data['hydra:member'].length > 0) {
                    displayMessage('Messages received:');
                    data['hydra:member'].forEach(msg => {
                        displayMessage(`From: ${msg.from.address}, Subject: ${msg.subject}`);
                    });
                } else {
                    displayMessage('No messages found.');
                }
            } catch (error) {
                displayMessage('Error fetching messages: ' + error.message);
            }
        }

        // Function to display messages in the output div
        function displayMessage(message) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML += `<p>${message}</p>`;
        }

    </script>

</body>
</html>
